<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>TestShop ‚Äî –û–ø—Ç–æ–≤—ã–π –≤–µ–π–ø—à–æ–ø</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background: #f9f9f9;
            color: #333;
        }

        header {
            background: #0f0f0f;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            color: #ff4d94;
        }

        .tabs {
            display: flex;
            gap: 20px;
            background: white;
            padding: 12px 20px;
            border-bottom: 1px solid #eee;
            overflow-x: auto;
        }

        .tab {
            padding: 8px 16px;
            cursor: pointer;
            font-weight: 600;
            border-radius: 6px;
            white-space: nowrap;
        }

        .tab.active {
            background: #ff4d94;
            color: white;
        }

        .subcategories {
            padding: 12px 20px;
            background: #f0f0f0;
            border-bottom: 1px solid #ddd;
            display: none;
            flex-wrap: wrap;
            gap: 10px;
        }

        .subcategory {
            padding: 6px 14px;
            background: white;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
        }

        .subcategory.active {
            background: #ff4d94;
            color: white;
        }

        .products {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
            padding: 20px;
        }

        .product-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: hidden;
            transition: transform 0.2s;
        }

        .product-card:hover {
            transform: translateY(-4px);
        }

        .product-img {
            width: 100%;
            height: 160px;
            object-fit: contain;
            background: #fafafa;
        }

        .product-info {
            padding: 12px;
        }

        .product-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .price-tier {
            font-size: 12px;
            color: #555;
            margin: 4px 0;
        }

        .add-to-cart {
            width: 100%;
            background: #ff4d94;
            color: white;
            border: none;
            padding: 8px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 8px;
        }

        .cart-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: #ff4d94;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(255, 77, 148, 0.4);
            z-index: 1000;
        }

        .cart-panel {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 320px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
            padding: 20px;
            display: none;
            max-height: 70vh;
            overflow-y: auto;
            z-index: 1000;
        }

        .cart-title {
            font-weight: 700;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .cart-item-info {
            flex: 1;
        }

        .cart-item-name {
            font-size: 14px;
            font-weight: 600;
        }

        .cart-item-qty {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 4px;
        }

        .qty-btn {
            width: 24px;
            height: 24px;
            background: #eee;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .checkout-form {
            margin-top: 20px;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 6px;
        }

        .checkout-btn {
            width: 100%;
            background: #ff4d94;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }

        .empty-cart {
            text-align: center;
            color: #888;
            padding: 20px 0;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4caf50;
            color: white;
            padding: 12px 20px;
            border-radius: 6px;
            display: none;
            z-index: 2000;
        }
    </style>
</head>
<body>

<header>
    <div class="logo">TestShop</div>
    <div>–û–ø—Ç–æ–≤—ã–π –≤–µ–π–ø—à–æ–ø ‚Äî –æ—Ç 1 —à—Ç!</div>
</header>

<div class="tabs">
    <div class="tab active" data-category="liquids">–ñ–∏–¥–∫–æ—Å—Ç–∏</div>
    <div class="tab" data-category="coils">–ò—Å–ø–∞—Ä–∏—Ç–µ–ª–∏/–ö–∞—Ä—Ç—Ä–∏–¥–∂–∏</div>
    <div class="tab" data-category="pods">–ü–æ–¥-—Å–∏—Å—Ç–µ–º—ã</div>
    <div class="tab" data-category="disposables">–û–¥–Ω–æ—Ä–∞–∑–∫–∏</div>
</div>

<div class="subcategories" id="subcategories">
    <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è -->
</div>

<div class="products" id="products">
    <!-- –¢–æ–≤–∞—Ä—ã –ø–æ–¥–≥—Ä—É–∂–∞—é—Ç—Å—è —Å—é–¥–∞ -->
</div>

<div class="cart-btn" id="cartBtn">üõí</div>

<div class="cart-panel" id="cartPanel">
    <div class="cart-title">–í–∞—à –∑–∞–∫–∞–∑</div>
    <div id="cartItems"></div>
    <div id="checkoutForm" class="checkout-form">
        <input type="text" class="form-input" id="telegramUser" placeholder="–í–∞—à @username –≤ Telegram">
        <input type="text" class="form-input" id="sdekAddress" placeholder="–ê–¥—Ä–µ—Å –°–î–≠–ö (–≥–æ—Ä–æ–¥ + –ø—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏)">
        <button class="checkout-btn" id="checkoutBtn">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
    </div>
</div>

<div class="notification" id="notification">–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É!</div>

<script>
    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Google Apps Script
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyWcRyTktyTNw6VNnFy2pFThF-uOMCIDM1RuXR5AARJn-Ba2truNqe-5bO7kZD4bk8n/exec';

    let products = [];
    let currentCategory = 'liquids';
    let currentSubcategory = null;
    let cart = JSON.parse(localStorage.getItem('cart')) || [];

    // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
    const tabs = document.querySelectorAll('.tab');
    const subcategoriesEl = document.getElementById('subcategories');
    const productsEl = document.getElementById('products');
    const cartBtn = document.getElementById('cartBtn');
    const cartPanel = document.getElementById('cartPanel');
    const cartItemsEl = document.getElementById('cartItems');
    const checkoutBtn = document.getElementById('checkoutBtn');
    const telegramInput = document.getElementById('telegramUser');
    const sdekInput = document.getElementById('sdekAddress');
    const notification = document.getElementById('notification');

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤
    async function fetchProducts() {
        try {
            const response = await fetch(APPS_SCRIPT_URL);
            if (!response.ok) throw new Error('Network response was not ok');
            const data = await response.json();
            return data.products || [];
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤:', e);
            productsEl.innerHTML = '<p style="grid-column:1/-1; text-align:center; padding:40px; color:#e74c3c;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Ç–∞–±–ª–∏—Ü–µ.</p>';
            return [];
        }
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤
    function renderProducts() {
        productsEl.innerHTML = '';
        const filtered = products.filter(item => {
            if (item.category !== currentCategory) return false;
            if (currentCategory === 'liquids' && currentSubcategory && item.subcategory !== currentSubcategory) return false;
            return true;
        });

        if (filtered.length === 0) {
            productsEl.innerHTML = '<p style="grid-column:1/-1; text-align:center; padding:40px; color:#888;">–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤</p>';
            return;
        }

        filtered.forEach(item => {
            const card = document.createElement('div');
            card.className = 'product-card';
            card.innerHTML = `
                <img src="${item.img || 'https://via.placeholder.com/150?text=No+Image'}" alt="${item.name}" class="product-img">
                <div class="product-info">
                    <div class="product-name">${item.name}</div>
                    <div class="price-tier">–æ—Ç 1 —à—Ç: ${item.price1} ‚ÇΩ</div>
                    <div class="price-tier">–æ—Ç 5 —à—Ç: ${item.price5} ‚ÇΩ</div>
                    <div class="price-tier">–æ—Ç 10 —à—Ç: ${item.price10} ‚ÇΩ</div>
                    <button class="add-to-cart" data-id="${item.id}">–í –∫–æ—Ä–∑–∏–Ω—É</button>
                </div>
            `;
            productsEl.appendChild(card);
        });

        document.querySelectorAll('.add-to-cart').forEach(btn => {
            btn.addEventListener('click', () => {
                const id = parseInt(btn.dataset.id);
                addToCart(id);
                showNotification();
            });
        });
    }

    // –†–µ–Ω–¥–µ—Ä —Å—É–±–∫–∞—Ç–µ–≥–æ—Ä–∏–π (—Ç–æ–ª—å–∫–æ –¥–ª—è –∂–∏–¥–∫–æ—Å—Ç–µ–π)
    function renderSubcategories() {
        if (currentCategory !== 'liquids') {
            subcategoriesEl.style.display = 'none';
            currentSubcategory = null;
            return;
        }

        const brands = [...new Set(
            products
                .filter(item => item.category === 'liquids' && item.subcategory)
                .map(item => item.subcategory)
        )];

        subcategoriesEl.innerHTML = '';
        const allBtn = document.createElement('div');
        allBtn.className = 'subcategory active';
        allBtn.textContent = '–í—Å–µ';
        allBtn.addEventListener('click', () => {
            currentSubcategory = null;
            document.querySelectorAll('.subcategory').forEach(el => el.classList.remove('active'));
            allBtn.classList.add('active');
            renderProducts();
        });
        subcategoriesEl.appendChild(allBtn);

        brands.forEach(brand => {
            const btn = document.createElement('div');
            btn.className = 'subcategory';
            btn.textContent = brand;
            btn.addEventListener('click', () => {
                currentSubcategory = brand;
                document.querySelectorAll('.subcategory').forEach(el => el.classList.remove('active'));
                btn.classList.add('active');
                renderProducts();
            });
            subcategoriesEl.appendChild(btn);
        });

        subcategoriesEl.style.display = 'flex';
    }

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            currentCategory = tab.dataset.category;
            renderSubcategories();
            renderProducts();
        });
    });

    // –ö–æ—Ä–∑–∏–Ω–∞
    function addToCart(productId) {
        const item = products.find(p => p.id === productId);
        if (!item) return;

        const existing = cart.find(i => i.id === productId);
        if (existing) {
            existing.qty += 1;
        } else {
            cart.push({ ...item, qty: 1 });
        }
        saveCart();
        updateCartView();
    }

    function updateCartView() {
        if (cart.length === 0) {
            cartItemsEl.innerHTML = '<div class="empty-cart">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div>';
            return;
        }

        cartItemsEl.innerHTML = '';
        cart.forEach(item => {
            const el = document.createElement('div');
            el.className = 'cart-item';
            el.innerHTML = `
                <div class="cart-item-info">
                    <div class="cart-item-name">${item.name}</div>
                    <div class="cart-item-qty">
                        <button class="qty-btn minus" data-id="${item.id}">-</button>
                        <span>${item.qty}</span>
                        <button class="qty-btn plus" data-id="${item.id}">+</button>
                    </div>
                </div>
                <div>${getPrice(item)} ‚ÇΩ</div>
            `;
            cartItemsEl.appendChild(el);
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ +/- 
        document.querySelectorAll('.plus').forEach(btn => {
            btn.addEventListener('click', () => {
                const id = parseInt(btn.dataset.id);
                const item = cart.find(i => i.id === id);
                if (item) {
                    item.qty += 1;
                    saveCart();
                    updateCartView();
                }
            });
        });

        document.querySelectorAll('.minus').forEach(btn => {
            btn.addEventListener('click', () => {
                const id = parseInt(btn.dataset.id);
                const item = cart.find(i => i.id === id);
                if (item && item.qty > 1) {
                    item.qty -= 1;
                    saveCart();
                    updateCartView();
                } else if (item && item.qty === 1) {
                    cart = cart.filter(i => i.id !== id);
                    saveCart();
                    updateCartView();
                }
            });
        });
    }

    function getPrice(item) {
        if (item.qty >= 10) return item.price10 * item.qty;
        if (item.qty >= 5) return item.price5 * item.qty;
        return item.price1 * item.qty;
    }

    function saveCart() {
        localStorage.setItem('cart', JSON.stringify(cart));
    }

    // –û—Ç–∫—Ä—ã—Ç–∏–µ/–∑–∞–∫—Ä—ã—Ç–∏–µ –∫–æ—Ä–∑–∏–Ω—ã
    cartBtn.addEventListener('click', () => {
        cartPanel.style.display = cartPanel.style.display === 'block' ? 'none' : 'block';
    });

    // –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞
    checkoutBtn.addEventListener('click', () => {
        const tg = telegramInput.value.trim();
        const addr = sdekInput.value.trim();

        if (!tg || !addr) {
            alert('–£–∫–∞–∂–∏—Ç–µ Telegram –∏ –∞–¥—Ä–µ—Å –°–î–≠–ö!');
            return;
        }

        if (cart.length === 0) {
            alert('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞!');
            return;
        }

        let message = `–ù–û–í–´–ô –ó–ê–ö–ê–ó%0A%0A`;
        message += `Telegram: ${tg}%0A`;
        message += `–°–î–≠–ö: ${addr}%0A%0A`;
        message += `–¢–æ–≤–∞—Ä—ã:%0A`;
        cart.forEach(item => {
            message += `- ${item.name} x${item.qty} = ${getPrice(item)} ‚ÇΩ%0A`;
        });
        message += `%0A–ò—Ç–æ–≥–æ: ${cart.reduce((sum, item) => sum + getPrice(item), 0)} ‚ÇΩ`;

        window.open(`https://t.me/YodaShopSupportBot?start=${encodeURIComponent(message)}`, '_blank');

        cart = [];
        saveCart();
        updateCartView();
        telegramInput.value = '';
        sdekInput.value = '';
        cartPanel.style.display = 'none';
        alert('–ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Telegram.');
    });

    function showNotification() {
        notification.style.display = 'block';
        setTimeout(() => {
            notification.style.display = 'none';
        }, 2000);
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    (async () => {
        products = await fetchProducts();
        renderSubcategories();
        renderProducts();
        updateCartView();
    })();

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–∞–Ω–µ–ª–∏ –∫–æ—Ä–∑–∏–Ω—ã –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
    document.addEventListener('click', (e) => {
        if (!cartPanel.contains(e.target) && e.target !== cartBtn) {
            cartPanel.style.display = 'none';
        }
    });
</script>

</body>
</html>
